<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionale Clienti Assicurati</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body{background:#f5f9ff;color:#003366;padding:2rem;font-family:'Segoe UI',sans-serif}
    h1{color:#ff6600}
    .section{background:#fff;border-radius:1rem;padding:2rem;margin-bottom:2rem;box-shadow:0 0 10px rgba(0,0,0,.1)}
    .btn-orange{background:#ff6600;color:#fff}.btn-orange:hover{background:#e65c00}
    .hidden{display:none}
    .whatsapp-icon{color:#25D366;cursor:pointer;font-size:1.3rem}
    .sortable{cursor:pointer}
    .sortable.asc::after{content:' \25B2';font-size:0.8rem}
    .sortable.desc::after{content:' \25BC';font-size:0.8rem}
    .table-warning{background:#fff8e1 !important}
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Gestionale Clienti Assicurati</h1>

  <!-- DASHBOARD -->
  <div class="dashboard row text-center section">
    <div class="col-md-4"><div class="card p-3"><h6>Totale Clienti</h6><h2 id="tot-clienti">0</h2></div></div>
    <div class="col-md-4"><div class="card p-3"><h6>In Scadenza 30 gg</h6><h2 id="tot-scadenza">0</h2></div></div>
    <div class="col-md-4"><div class="card p-3"><h6>Premi Lordi (‚Ç¨)</h6><h2 id="tot-premio">0</h2></div></div>
  </div>

  <!-- FORM -->
  <div class="section">
    <form id="formCliente" class="row g-3">
      <div class="col-md-6"><input id="nome" class="form-control" placeholder="Nome" required></div>
      <div class="col-md-6"><input id="cognome" class="form-control" placeholder="Cognome" required></div>
      <div class="col-md-6"><input id="cellulare" class="form-control" placeholder="Cellulare (senza +)" required></div>
      <div class="col-md-6">
        <select id="tipologia" class="form-select" required>
          <option value="">Tipologia...</option>
          <option value="RC AUTO">RC AUTO</option>
          <option value="ALTRI RAMI">ALTRI RAMI</option>
        </select>
      </div>

      <!-- RC AUTO -->
      <div id="rcFields" class="hidden row g-3">
        <div class="col-md-6"><input id="targa" class="form-control" placeholder="Targa"></div>
        <div class="col-md-6">
          <select id="frazionamento" class="form-select">
            <option value="">Frazionamento...</option>
            <option value="6">6 mesi</option>
            <option value="12">12 mesi</option>
          </select>
        </div>
      </div>

      <!-- ALTRI RAMI -->
      <div id="ramiFields" class="hidden row g-3">
        <div class="col-md-6"><input id="dettaglio" class="form-control" placeholder="Dettaglio"></div>
        <div class="col-md-6"><input id="tipoPolizza" class="form-control" placeholder="Tipologia Polizza"></div>
        <div class="col-md-6">
          <select id="scadenzaMesi" class="form-select">
            <option value="">Scadenza (mesi)</option>
            <option>1</option><option>3</option><option>6</option><option>9</option><option>12</option>
          </select>
        </div>
        <div class="col-md-6"><input id="note" class="form-control" placeholder="Note"></div>
        <div class="col-md-6"><input id="massimale" class="form-control" placeholder="Massimale"></div>
        <div class="col-md-6"><input id="tipoAttivita" class="form-control" placeholder="Tipologia Attivit√†"></div>
      </div>

      <div class="col-md-6"><input id="inizio" type="date" class="form-control" placeholder="Inizio copertura" required></div>
      <div class="col-md-6"><input id="assicurazione" class="form-control" placeholder="Assicurazione"></div>
      <div class="col-md-6"><input id="azienda" class="form-control" placeholder="Azienda"></div>
      <div class="col-md-6"><input id="premio" type="number" step="0.01" class="form-control" placeholder="Premio Lordo"></div>
      <div class="col-12"><button class="btn btn-orange" type="submit">Salva Cliente</button></div>
    </form>
  </div>

  <!-- ACTIONS -->
  <div class="section d-flex flex-wrap gap-3 justify-content-between">
    <div class="d-flex flex-column gap-2">
      <button class="btn btn-orange" id="btnScadenza">In Scadenza (30 giorni)</button>
      <button class="btn btn-secondary" id="btnMsgs">Messaggi Inviati</button>
      <input id="search" placeholder="Cerca..." class="form-control">
    </div>
    <div class="d-flex flex-column gap-2">
      <button class="btn btn-outline-primary" id="btnCSV">CSV</button>
      <button class="btn btn-outline-secondary" id="btnPDF">PDF</button>
    </div>
  </div>

  <!-- LISTA -->
  <div class="section p-0">
    <table class="table table-striped mb-0" id="tbl">
      <thead class="table-light"><tr>
        <th class="sortable" data-k="nome">Nome</th>
        <th class="sortable" data-k="cognome">Cognome</th>
        <th class="sortable" data-k="tipologia">Tipologia</th>
        <th class="sortable" data-k="scadenza">Scadenza</th>
        <th>Azioni</th>
      </tr></thead>
      <tbody id="listaClienti"></tbody>
    </table>
  </div>
</div>

<script>
const API='https://gestionale-clienti-assicurati.onrender.com/api';
let clienti=[];let sortKey='nome',sortAsc=true,logMsgs=[];
const $=qs=>document.querySelector(qs);
const fmt=d=>new Date(d).toLocaleDateString();

// campi dinamici
$('#tipologia').addEventListener('change',e=>{
  $('#rcFields').classList.add('hidden');
  $('#ramiFields').classList.add('hidden');
  if(e.target.value==='RC AUTO') $('#rcFields').classList.remove('hidden');
  if(e.target.value==='ALTRI RAMI') $('#ramiFields').classList.remove('hidden');
});

// load iniziale
(async()=>{try{const r=await fetch(`${API}/clienti`);if(!r.ok)throw new Error(r.status);clienti=await r.json();render();}catch(err){console.error(err);alert('Errore load '+err.message);}})();

// render table + dash
function render(list=clienti){const tbody=$('#listaClienti');tbody.innerHTML='';list=[...list].sort((a,b)=>{if(a[sortKey]>b[sortKey])return sortAsc?1:-1;if(a[sortKey]<b[sortKey])return sortAsc?-1:1;return 0;});list.forEach(c=>{const tr=document.createElement('tr');if((c.scadenza-Date.now())/86400000<=30)tr.classList.add('table-warning');tr.innerHTML=`<td>${c.nome}</td><td>${c.cognome}</td><td>${c.tipologia}</td><td>${fmt(c.scadenza)}</td><td class='d-flex gap-2'>
      <span class='whatsapp-icon' title='Invia WhatsApp' onclick="sendWhats('${c.cellulare}','${encodeURIComponent('La tua polizza √® in scadenza, ti invitiamo in ufficio per visionare la nuova proposta!')}','${c.nome} ${c.cognome}')">üü¢</span>
      <button class='btn btn-sm btn-danger' onclick='delCliente("${c._id}")'>üóëÔ∏è</button></td>`;tbody.appendChild(tr);});
  $('#tot-clienti').textContent=clienti.length;
  $('#tot-premio').textContent=clienti.reduce((s,c)=>s+Number(c.premio||0),0).toFixed(2);
  $('#tot-scadenza').textContent=clienti.filter(c=>(c.scadenza-Date.now())/86400000<=30).length;
}

// sortable headers
$$=sel=>document.querySelectorAll(sel);
$$('
