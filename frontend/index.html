<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestionale Clienti Assicurati</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>body { padding: 2rem; }</style>
</head>
<body>
<div class="container">
  <h1>Gestionale Clienti</h1>
  <form id="formCliente" class="mb-3">
    <input id="nome" placeholder="Nome" class="form-control mb-1" required>
    <input id="cognome" placeholder="Cognome" class="form-control mb-1" required>
    <input id="tipologia" placeholder="Tipologia" class="form-control mb-1">
    <input id="scadenza" placeholder="Scadenza (YYYY-MM-DD)" class="form-control mb-1">
    <button class="btn btn-success">Aggiungi Cliente</button>
  </form>
  <button onclick="exportCSV()" class="btn btn-outline-primary">Esporta CSV</button>
  <button onclick="exportPDF()" class="btn btn-outline-secondary">Esporta PDF</button>
  <ul id="listaClienti" class="list-group mt-3"></ul>
</div>
<script>
const api = 'https://gestionale-clienti-assicurati.onrender.com/api';

document.getElementById('formCliente').addEventListener('submit', async (e) => {
  e.preventDefault();
  const cliente = {
    nome: nome.value, cognome: cognome.value,
    tipologia: tipologia.value, scadenza: new Date(scadenza.value)
  };
  await fetch(`${api}/clienti`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(cliente)
  });
  e.target.reset(); fetchClienti();
});

async function fetchClienti() {
  const res = await fetch(`${api}/clienti`);
  const clienti = await res.json();
  const lista = document.getElementById('listaClienti');
  lista.innerHTML = '';
  clienti.forEach(c => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between';
    li.innerHTML = `${c.nome} ${c.cognome} - ${c.tipologia} - ${new Date(c.scadenza).toLocaleDateString()} <button class='btn btn-sm btn-danger' onclick='deleteCliente("${c._id}")'>X</button>`;
    lista.appendChild(li);
  });
}

async function deleteCliente(id) {
  await fetch(`${api}/clienti/${id}`, { method: 'DELETE' });
  fetchClienti();
}

function exportCSV() {
  fetch(`${api}/clienti`)
    .then(res => res.json())
    .then(clienti => {
      const csv = 'Nome,Cognome,Tipologia,Scadenza\n' +
        clienti.map(c => `${c.nome},${c.cognome},${c.tipologia},${new Date(c.scadenza).toLocaleDateString()}`).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'clienti.csv'; a.click();
    });
}

async function exportPDF() {
  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  const res = await fetch(`${api}/clienti`);
  const clienti = await res.json();
  doc.text('Clienti', 10, 10); let y = 20;
  clienti.forEach(c => {
    doc.text(`${c.nome} ${c.cognome} - ${c.tipologia} - ${new Date(c.scadenza).toLocaleDateString()}`, 10, y); y += 10;
  });
  doc.save('clienti.pdf');
}

fetchClienti();
</script>
</body>
</html>
