<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestionale Clienti Assicurati</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 2rem; }
    .section { background: #fff; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th.sortable { cursor: pointer; }
    th.sortable::after { content: '\25B4\25BE'; font-size: 0.7em; margin-left: 5px; }
    .table-warning { background-color: #fff8dc; }
    .btn { padding: 0.5rem 1rem; margin: 0.3rem; cursor: pointer; border: none; border-radius: 5px; }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-orange { background-color: #ff6600; color: white; }
    .whatsapp-icon { color: #25D366; font-size: 1.3rem; cursor: pointer; }
  </style>
</head>
<body>
  <div class="section">
    <h1>Gestionale Clienti Assicurati</h1>
    <form id="form">
      <input type="hidden" id="_id" />
      <input id="nome" placeholder="Nome" required />
      <input id="cognome" placeholder="Cognome" required />
      <input id="cellulare" placeholder="Cellulare (senza +)" required />
      <select id="tipologia" required>
        <option value="">Tipologia...</option>
        <option value="RC AUTO">RC AUTO</option>
        <option value="ALTRI RAMI">ALTRI RAMI</option>
      </select>
      <div id="rcFields" style="display:none">
        <input id="targa" placeholder="Targa" />
        <select id="frazionamento">
          <option value="">Frazionamento...</option>
          <option value="6">6 mesi</option>
          <option value="12">12 mesi</option>
        </select>
      </div>
      <div id="ramiFields" style="display:none">
        <input id="dettaglio" placeholder="Dettaglio" />
        <input id="tipoPolizza" placeholder="Tipologia Polizza" />
        <select id="scadenzaMesi">
          <option value="">Scadenza (mesi)...</option>
          <option>1</option><option>3</option><option>6</option><option>9</option><option>12</option>
        </select>
        <input id="note" placeholder="Note" />
        <input id="massimale" placeholder="Massimale" />
        <input id="tipoAttivita" placeholder="Tipologia AttivitÃ " />
      </div>
      <input id="inizio" type="date" required />
      <input id="assicurazione" placeholder="Assicurazione" />
      <input id="azienda" placeholder="Azienda" />
      <input id="premio" type="number" placeholder="Premio Lordo" />
      <button type="submit" class="btn btn-orange">Salva Cliente</button>
    </form>
    <button id="btnPDF" class="btn btn-primary">Esporta PDF</button>
    <table id="tbl">
      <thead>
        <tr>
          <th class="sortable" data-k="nome">Nome</th>
          <th class="sortable" data-k="cognome">Cognome</th>
          <th>Cellulare</th>
          <th class="sortable" data-k="tipologia">Tipologia</th>
          <th class="sortable" data-k="scadenza">Scadenza</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>
  </div>

<script>
const API = 'https://gestionale-clienti-assicurati.onrender.com/api';
let clienti = [];
let sortKey = 'nome';
let sortAsc = true;

const $ = qs => document.querySelector(qs);
const $$ = q => document.querySelectorAll(q);
const fmt = d => new Date(d).toLocaleDateString();

$('#tipologia').addEventListener('change', e => {
  $('#rcFields').style.display = e.target.value === 'RC AUTO' ? '' : 'none';
  $('#ramiFields').style.display = e.target.value === 'ALTRI RAMI' ? '' : 'none';
});

(async () => {
  try {
    const r = await fetch(`${API}/clienti`);
    if (!r.ok) throw new Error(r.status);
    clienti = await r.json();
    render();
  } catch (err) {
    alert('Errore caricamento clienti: ' + err.message);
  }
})();

function render(list = clienti) {
  const tbody = $('#lista');
  tbody.innerHTML = '';
  list = [...list].sort((a, b) => {
    if (a[sortKey] > b[sortKey]) return sortAsc ? 1 : -1;
    if (a[sortKey] < b[sortKey]) return sortAsc ? -1 : 1;
    return 0;
  });
  list.forEach(c => {
    const tr = document.createElement('tr');
    const giorniAllaScadenza = (c.scadenza - Date.now()) / 86400000;
    if (giorniAllaScadenza <= 30) tr.classList.add('table-warning');
    tr.innerHTML = `
      <td>${c.nome}</td>
      <td>${c.cognome}</td>
      <td>${c.cellulare}</td>
      <td>${c.tipologia}</td>
      <td>${fmt(c.scadenza)}</td>
      <td>
        <button class='btn btn-primary' onclick='modificaCliente(${JSON.stringify(c)})'>Modifica</button>
        <button class='btn btn-danger' onclick='eliminaCliente("${c._id}")'>Elimina</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function modificaCliente(c) {
  Object.keys(c).forEach(k => {
    if ($("#" + k)) $("#" + k).value = c[k];
  });
  $('#_id').value = c._id;
  $('#rcFields').style.display = c.tipologia === 'RC AUTO' ? '' : 'none';
  $('#ramiFields').style.display = c.tipologia === 'ALTRI RAMI' ? '' : 'none';
}

async function eliminaCliente(id) {
  if (!confirm('Confermi eliminazione?')) return;
  await fetch(`${API}/clienti/${id}`, { method: 'DELETE' });
  clienti = clienti.filter(c => c._id !== id);
  render();
}

$('#form').addEventListener('submit', async e => {
  e.preventDefault();
  const f = e.target;
  const obj = {
    nome: f.nome.value,
    cognome: f.cognome.value,
    cellulare: f.cellulare.value,
    tipologia: f.tipologia.value,
    inizio: new Date(f.inizio.value).getTime(),
    assicurazione: f.assicurazione.value,
    azienda: f.azienda.value,
    premio: f.premio.value
  };
  if (obj.tipologia === 'RC AUTO') {
    obj.targa = f.targa.value;
    obj.frazionamento = f.frazionamento.value;
    obj.scadenza = obj.inizio + (parseInt(obj.frazionamento) || 12) * 30 * 86400000;
  } else {
    obj.dettaglio = f.dettaglio.value;
    obj.polizza = f.tipoPolizza.value;
    obj.scadenza = obj.inizio + (parseInt(f.scadenzaMesi.value) || 12) * 30 * 86400000;
    obj.note = f.note.value;
    obj.massimale = f.massimale.value;
    obj.attivita = f.tipoAttivita.value;
  }
  const method = f._id.value ? 'PUT' : 'POST';
  const url = method === 'PUT' ? `${API}/clienti/${f._id.value}` : `${API}/clienti`;
  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(obj)
  });
  const cli = await res.json();
  if (method === 'POST') clienti.push(cli);
  else clienti = clienti.map(c => (c._id === cli._id ? cli : c));
  f.reset();
  render();
});

$('#btnPDF').addEventListener('click', () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text('Clienti Assicurati', 10, 10);
  let y = 20;
  clienti.forEach(c => {
    doc.text(`${c.nome} ${c.cognome} - ${c.tipologia} - ${fmt(c.scadenza)}`, 10, y);
    y += 8;
    if (y > 280) { doc.addPage(); y = 20; }
  });
  doc.save('clienti.pdf');
});

$$('th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const k = th.dataset.k;
    sortAsc = sortKey === k ? !sortAsc : true;
    sortKey = k;
    render();
  });
});
</script>
</body>
</html>
