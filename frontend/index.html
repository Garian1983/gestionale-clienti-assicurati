<script>
const API = 'https://gestionale-clienti-assicurati.onrender.com/api';
let clienti=[];let sendingLog=[];let sortKey='nome',sortAsc=true;
const $=s=>document.querySelector(s);
function fmt(d){return new Date(d).toLocaleDateString();}
function days(d){return Math.ceil((d-Date.now())/86400000);}

window.addEventListener('DOMContentLoaded',load);
async function load(){
  try {
    const r = await fetch(`${API}/clienti`);
    if (!r.ok) throw new Error('Errore nel caricamento dei clienti');
    clienti = await r.json();
    render();
  } catch (err) {
    console.error('Errore nel load():', err);
    alert('Errore nel caricamento dei clienti. Controlla la console.');
  }
}

$('#tipologia').addEventListener('change',e=>{
  $('#rcFields').classList.add('hidden');
  $('#ramiFields').classList.add('hidden');
  if(e.target.value==='RC AUTO') $('#rcFields').classList.remove('hidden');
  if(e.target.value==='ALTRI RAMI') $('#ramiFields').classList.remove('hidden');
});

$('#formCliente').addEventListener('submit',async e=>{
  e.preventDefault();
  const f = e.target;
  const o = {
    nome: f.nome.value,
    cognome: f.cognome.value,
    cellulare: f.cellulare.value,
    tipologia: f.tipologia.value,
    inizio: new Date(f.inizio.value).getTime(),
    assicurazione: f.assicurazione.value,
    azienda: f.azienda.value,
    premio: f.premio.value
  };

  if(o.tipologia==='RC AUTO'){
    o.targa = f.targa.value;
    o.frazionamento = f.frazionamento.value;
    const m = parseInt(o.frazionamento)||12;
    o.scadenza = o.inizio + m*30*86400000;
  } else {
    o.dettaglio = f.dettaglio.value;
    o.polizza = f.tipoPolizza.value;
    o.scadenza = o.inizio + (parseInt(f.scadenzaMesi.value)||12)*30*86400000;
    o.note = f.note.value;
    o.massimale = f.massimale.value;
    o.attivita = f.tipoAttivita.value;
  }

  try {
    const res = await fetch(`${API}/clienti`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(o)
    });

    if (!res.ok) {
      const error = await res.json();
      console.error('Errore salvataggio:', error);
      alert('Errore nel salvataggio del cliente: ' + (error.message || 'Verifica la console.'));
      return;
    }

    const nuovoCliente = await res.json();
    clienti.push(nuovoCliente);
    render();
    f.reset();
    $('#rcFields').classList.add('hidden');
    $('#ramiFields').classList.add('hidden');
  } catch (err) {
    console.error('Errore nella POST:', err);
    alert('Errore di rete o server durante il salvataggio.');
  }
});
</script>
