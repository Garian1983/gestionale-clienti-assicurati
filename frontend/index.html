<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionale Clienti Assicurati</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body{background:#f5f9ff;color:#003366;padding:2rem;font-family:'Segoe UI',sans-serif}
    h1{color:#ff6600}
    .section{background:#fff;border-radius:1rem;padding:2rem;margin-bottom:2rem;box-shadow:0 0 10px rgba(0,0,0,.1)}
    .btn-orange{background:#ff6600;color:#fff}.btn-orange:hover{background:#e65c00}
    .hidden{display:none}
    .whatsapp-icon{color:#25D366;cursor:pointer;font-size:1.3rem}
    .sortable{cursor:pointer}
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Gestionale Clienti Assicurati</h1>

  <!-- FORM -->
  <div class="section">
    <form id="formCliente" class="row g-3">
      <div class="col-md-6"><input id="nome" class="form-control" placeholder="Nome" required></div>
      <div class="col-md-6"><input id="cognome" class="form-control" placeholder="Cognome" required></div>
      <div class="col-md-6"><input id="cellulare" class="form-control" placeholder="Cellulare (senza +)" required></div>
      <div class="col-md-6">
        <select id="tipologia" class="form-select" required>
          <option value="">Tipologia...</option>
          <option value="RC AUTO">RC AUTO</option>
          <option value="ALTRI RAMI">ALTRI RAMI</option>
        </select>
      </div>

      <!-- RC AUTO -->
      <div id="rcFields" class="hidden row g-3">
        <div class="col-md-6"><input id="targa" class="form-control" placeholder="Targa"></div>
        <div class="col-md-6">
          <select id="frazionamento" class="form-select">
            <option value="">Frazionamento...</option>
            <option value="6">6 mesi</option>
            <option value="12">12 mesi</option>
          </select>
        </div>
      </div>

      <!-- ALTRI RAMI -->
      <div id="ramiFields" class="hidden row g-3">
        <div class="col-md-6"><input id="dettaglio" class="form-control" placeholder="Dettaglio"></div>
        <div class="col-md-6"><input id="tipoPolizza" class="form-control" placeholder="Tipologia Polizza"></div>
        <div class="col-md-6">
          <select id="scadenzaMesi" class="form-select">
            <option value="">Scadenza (mesi)</option>
            <option>1</option><option>3</option><option>6</option><option>9</option><option>12</option>
          </select>
        </div>
        <div class="col-md-6"><input id="note" class="form-control" placeholder="Note"></div>
        <div class="col-md-6"><input id="massimale" class="form-control" placeholder="Massimale"></div>
        <div class="col-md-6"><input id="tipoAttivita" class="form-control" placeholder="Tipologia AttivitÃ "></div>
      </div>

      <div class="col-md-6"><input id="inizio" type="date" class="form-control" placeholder="Inizio copertura" required></div>
      <div class="col-md-6"><input id="assicurazione" class="form-control" placeholder="Assicurazione"></div>
      <div class="col-md-6"><input id="azienda" class="form-control" placeholder="Azienda"></div>
      <div class="col-md-6"><input id="premio" type="number" step="0.01" class="form-control" placeholder="Premio Lordo"></div>
      <div class="col-12"><button class="btn btn-orange" type="submit">Salva Cliente</button></div>
    </form>
  </div>

  <!-- LISTA -->
  <div class="section p-0">
    <table class="table table-striped mb-0">
      <thead class="table-light"><tr>
        <th>Nome</th><th>Cognome</th><th>Tipologia</th><th>Scadenza</th><th>Azioni</th>
      </tr></thead>
      <tbody id="listaClienti"></tbody>
    </table>
  </div>
</div>

<script>
const API='https://gestionale-clienti-assicurati.onrender.com/api';
let clienti=[];
const $=s=>document.querySelector(s);
function fmt(t){return new Date(t).toLocaleDateString();}

// Mostra campi dinamici
$('#tipologia').addEventListener('change',e=>{
  $('#rcFields').classList.add('hidden');
  $('#ramiFields').classList.add('hidden');
  if(e.target.value==='RC AUTO') $('#rcFields').classList.remove('hidden');
  if(e.target.value==='ALTRI RAMI') $('#ramiFields').classList.remove('hidden');
});

// Carica clienti
async function load(){
  try{
    const r=await fetch(`${API}/clienti`);
    if(!r.ok) throw new Error('Status '+r.status);
    clienti=await r.json();
    render();
  }catch(err){
    console.error('load()',err);
    alert('Errore nel caricamento: '+err.message);
  }
}

// Renderizza tabella
function render(){
  const tbody=$('#listaClienti');
  tbody.innerHTML='';
  clienti.forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.nome}</td><td>${c.cognome}</td><td>${c.tipologia}</td><td>${fmt(c.scadenza)}</td>
      <td><button class='btn btn-sm btn-danger' onclick='delCliente("${c._id}")'>Elimina</button></td>`;
    tbody.appendChild(tr);
  });
}

// Salva cliente
$('#formCliente').addEventListener('submit',async e=>{
  e.preventDefault();
  const f=e.target;const obj={nome:f.nome.value,cognome:f.cognome.value,cellulare:f.cellulare.value,tipologia:f.tipologia.value,inizio:new Date(f.inizio.value).getTime(),assicurazione:f.assicurazione.value,azienda:f.azienda.value,premio:f.premio.value};
  if(obj.tipologia==='RC AUTO'){
    obj.targa=f.targa.value;obj.frazionamento=f.frazionamento.value;const m=parseInt(obj.frazionamento)||12;obj.scadenza=obj.inizio+m*30*86400000;
  }else{
    obj.dettaglio=f.dettaglio.value;obj.polizza=f.tipoPolizza.value;obj.scadenza=obj.inizio+(parseInt(f.scadenzaMesi.value)||12)*30*86400000;obj.note=f.note.value;obj.massimale=f.massimale.value;obj.attivita=f.tipoAttivita.value;
  }
  try{
    const res=await fetch(`${API}/clienti`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});
    if(!res.ok) throw new Error('Status '+res.status);
    const nuovo=await res.json();clienti.push(nuovo);render();f.reset();$('#rcFields').classList.add('hidden');$('#ramiFields').classList.add('hidden');
  }catch(err){console.error('POST',err);alert('Errore salvataggio: '+err.message);} 
});

// Elimina cliente
async function delCliente(id){
  if(!confirm('Eliminare cliente?'))return;
  try{
    const r=await fetch(`${API}/clienti/`+id,{method:'DELETE'});
    if(!r.ok) throw new Error('Status '+r.status);
    clienti=clienti.filter(c=>c._id!==id);render();
  }catch(err){alert('Errore eliminazione: '+err.message);}
}

load();
</script>
</body>
</html>
